// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

/// Status do pipeline de produção do vídeo
enum VideoStatus {
  PENDING // Aguardando início
  SCRIPT_GENERATING // Gerando roteiro
  SCRIPT_READY // Roteiro pronto
  AUDIO_GENERATING // Gerando narração
  AUDIO_READY // Narração pronta
  IMAGES_GENERATING // Gerando imagens
  IMAGES_READY // Imagens prontas
  MOTION_GENERATING // Gerando movimento (vídeo)
  MOTION_READY // Movimento pronto
  RENDERING // Renderizando vídeo
  COMPLETED // Vídeo finalizado
  FAILED // Falha no pipeline
  CANCELLED // Cancelado pelo usuário
}

/// Tipo de provedor de IA usado
enum AIProvider {
  OPENAI
  ANTHROPIC
  GEMINI
  ELEVENLABS
  MIDJOURNEY
  STABLE_DIFFUSION
  RUNWAY
  REPLICATE
}

// =============================================================================
// MODELS
// =============================================================================

/// Projeto de vídeo - entidade principal
model Video {
  id     String      @id @default(uuid())
  title  String      @db.VarChar(255)
  theme  String      @db.Text
  status VideoStatus @default(PENDING)

  // Metadados
  duration          Int?    @default(185) // Duração alvo/estimada em segundos
  targetWPM         Int?    @default(150) // Velocidade de fala alvo (Words Per Minute): 120 (lenta), 150 (média), 180 (rápida)
  language          String  @default("pt-BR") @db.VarChar(10)
  narrationLanguage String  @default("pt-BR") @db.VarChar(10) // Idioma da narração (pode ser diferente do idioma do roteiro)
  style             String  @default("documentary") @db.VarChar(50) // documentary, mystery, narrative, educational
  sourceDocument    String? @db.Text // Documento/história base fornecido pelo usuário

  // Opções de Geração
  voiceId        String? @db.VarChar(100)
  imageStyle     String? @db.VarChar(50)
  visualStyle    String? @db.VarChar(50)
  aspectRatio    String? @db.VarChar(10)
  enableMotion   Boolean @default(false)
  scriptApproved Boolean @default(false)
  imagesApproved Boolean @default(false)
  videosApproved Boolean @default(false)

  // Vídeo final renderizado (comprimido com gzip)
  outputData     Bytes? // BYTEA comprimido
  outputMimeType String? @db.VarChar(50) // video/mp4
  outputSize     Int? // Tamanho antes da compressão
  thumbnailPath  String? @db.VarChar(500) // Thumbnail continua em arquivo (pequeno)

  // Diretrizes de conteúdo
  mustInclude String? @db.Text // O que deve ter no roteiro
  mustExclude String? @db.Text // O que NÃO deve ter no roteiro

  // Logs e erros
  errorMessage String? @db.Text
  pipelineLog  Json? // Array de log entries

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relacionamentos inversos
  script      Script?
  scenes      Scene[]
  audioTracks AudioTrack[]
  executions  PipelineExecution[]

  // Seed usada neste vídeo
  seedId String?
  seed   Seed?   @relation("VideoSeed", fields: [seedId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("videos")
}

/// Roteiro completo do vídeo
model Script {
  id      String @id @default(uuid())
  videoId String @unique
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Conteúdo
  summary   String @db.Text // Sinopse expandida da história (2-3 parágrafos)
  fullText  String @db.Text
  wordCount Int    @default(0)

  // Proveniência
  provider   AIProvider
  modelUsed  String?    @db.VarChar(100)
  promptUsed String?    @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scripts")
}

/// Cena individual do vídeo (segmento do roteiro)
model Scene {
  id      String @id @default(uuid())
  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Ordenação
  order Int

  // Conteúdo
  narration         String  @db.Text // Texto da narração
  visualDescription String  @db.Text // Descrição visual para geração de imagem
  audioDescription  String? @db.Text // Descrição de SFX/Atmosfera sonora

  // Timing
  startTime Float? // Início em segundos
  endTime   Float? // Fim em segundos

  // Assets gerados
  images SceneImage[]
  videos SceneVideo[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([videoId, order])
  @@index([videoId])
  @@map("scenes")
}

/// Imagem gerada para uma cena
model SceneImage {
  id      String @id @default(uuid())
  sceneId String
  scene   Scene  @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  // Proveniência
  provider   AIProvider
  promptUsed String     @db.Text

  // Dados (comprimido com gzip)
  fileData     Bytes? // BYTEA comprimido
  mimeType     String? @db.VarChar(50) // image/png, image/jpeg
  originalSize Int? // Tamanho antes da compressão
  width        Int?
  height       Int?

  // Variantes (para seleção)
  isSelected   Boolean @default(false)
  variantIndex Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([sceneId])
  @@map("scene_images")
}

/// Vídeo/Motion gerado para uma cena
model SceneVideo {
  id      String @id @default(uuid())
  sceneId String
  scene   Scene  @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  // Proveniência
  provider   AIProvider
  promptUsed String?    @db.Text // Pode ser nulo se for image-to-video

  // Dados (comprimido com gzip)
  fileData     Bytes? // BYTEA comprimido
  mimeType     String? @db.VarChar(50) // video/mp4
  originalSize Int? // Tamanho antes da compressão
  duration     Float? // Duração em segundos

  // Origem
  sourceImageId String? // ID da SceneImage usada como input (se houver)

  // Variantes
  isSelected   Boolean @default(false)
  variantIndex Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([sceneId])
  @@map("scene_videos")
}

/// Trilha de áudio gerada
model AudioTrack {
  id      String @id @default(uuid())
  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Tipo
  type String @db.VarChar(50) // "narration", "background_music", "sfx"

  // Proveniência
  provider AIProvider
  voiceId  String?    @db.VarChar(100) // ID da voz no ElevenLabs, etc.

  // Dados (comprimido com gzip)
  fileData     Bytes? // BYTEA comprimido
  mimeType     String? @db.VarChar(50) // audio/mpeg, audio/wav
  originalSize Int? // Tamanho antes da compressão
  duration     Float? // Duração em segundos

  // Timestamps
  createdAt DateTime @default(now())

  @@index([videoId])
  @@map("audio_tracks")
}

/// Configuração de provedores de IA
model ProviderConfig {
  id       String     @id @default(uuid())
  provider AIProvider @unique

  // Configurações
  apiKey   String  @db.VarChar(500) // Encriptado
  isActive Boolean @default(true)
  settings Json? // Configurações específicas do provedor

  // Rate limiting
  requestsPerMinute Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("provider_configs")
}

/// Logs de execução do pipeline
model PipelineExecution {
  id      String @id @default(uuid())
  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Etapa
  step   String @db.VarChar(50) // "script", "audio", "images", "render"
  status String @db.VarChar(20) // "started", "completed", "failed"

  // Detalhes
  message  String? @db.Text
  metadata Json?

  // Performance
  durationMs Int?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([videoId])
  @@index([createdAt])
  @@map("pipeline_executions")
}

/// Estilos visuais disponíveis para geração de imagens e vídeos
model VisualStyle {
  id          String @id @default(uuid())
  name        String @db.VarChar(100)
  description String @db.Text

  // Estilo base (ex: "Cinematic 35mm", "Dark Fantasy", "Studio Ghibli")
  baseStyle String @db.Text

  // Tags categorizadas para WAN 2.2
  lightingTags    String @db.Text // Ex: "warm golden hour light, soft volumetric rays"
  atmosphereTags  String @db.Text // Ex: "mysterious, epic, dreamlike"
  compositionTags String @db.Text // Ex: "wide establishing shot, low angle"

  // Tags gerais (mantido para compatibilidade e detalhes extras)
  tags String @db.Text

  // Ordenação e visibilidade
  order    Int     @default(0)
  isActive Boolean @default(true)

  // Relacionamentos
  seeds Seed[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, order])
  @@map("visual_styles")
}

/// Estilos de roteiro disponíveis para geração de scripts
model ScriptStyle {
  id           String @id @default(uuid())
  name         String @db.VarChar(100)
  description  String @db.Text
  instructions String @db.Text // Instruções para o prompt de geração

  // Ordenação e visibilidade
  order    Int     @default(0)
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, order])
  @@map("script_styles")
}

/// Seeds para geração de imagens/vídeos (receitas visuais)
model Seed {
  id String @id @default(uuid())

  // Identificação
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Valor da seed
  value Int

  // Relacionamento OBRIGATÓRIO com estilo visual
  visualStyleId String
  visualStyle   VisualStyle @relation(fields: [visualStyleId], references: [id], onDelete: Cascade)

  // Contexto de uso
  category String? @db.VarChar(50)
  tags     String? @db.Text

  // Metadados
  usageCount Int     @default(0)
  isDefault  Boolean @default(false)
  isActive   Boolean @default(true)

  // Preview (opcional)
  previewUrl String? @db.VarChar(500)

  // Relacionamento com vídeos que usaram esta seed
  videos Video[] @relation("VideoSeed")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([visualStyleId, value])
  @@index([visualStyleId, isActive])
  @@index([isDefault])
  @@map("seeds")
}
