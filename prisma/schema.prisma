generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Dossiê - centro do sistema, contém todos materiais de research e pode gerar múltiplos outputs
model Dossier {
  id           String          @id @default(uuid())
  title        String          @db.VarChar(255)
  sourceText   String
  theme        String
  researchData Json?
  tags         String[]
  category     String?         @db.VarChar(50)
  isProcessed  Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  images       DossierImage[]
  notes        DossierNote[]
  sources      DossierSource[]
  outputs      Output[]

  @@index([category])
  @@index([createdAt])
  @@index([isProcessed])
  @@map("dossiers")
}

/// Fonte secundária do dossiê (artigo, paper, citação)
model DossierSource {
  id         String   @id @default(uuid())
  dossierId  String
  title      String   @db.VarChar(255)
  content    String
  sourceType String   @db.VarChar(50)
  url        String?  @db.VarChar(500)
  author     String?  @db.VarChar(255)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  dossier    Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@index([sourceType])
  @@map("dossier_sources")
}

/// Imagem de referência do dossiê
model DossierImage {
  id          String   @id @default(uuid())
  dossierId   String
  description String
  imageData   Bytes?
  mimeType    String?  @db.VarChar(50)
  url         String?  @db.VarChar(500)
  tags        String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  dossier     Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@map("dossier_images")
}

/// Nota de research/insight do usuário
model DossierNote {
  id        String   @id @default(uuid())
  dossierId String
  content   String
  noteType  String?  @db.VarChar(50)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dossier   Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@index([noteType])
  @@map("dossier_notes")
}

/// Output gerado a partir de um dossiê (vídeo, thread, post, etc.)
model Output {
  id                String              @id @default(uuid())
  outputType        OutputType
  format            String              @db.VarChar(50)
  title             String?             @db.VarChar(255)
  duration          Int?
  aspectRatio       String?             @db.VarChar(10)
  platform          String?             @db.VarChar(50)
  targetWPM         Int?                @default(150)
  language          String              @default("pt-BR") @db.VarChar(10)
  narrationLanguage String              @default("pt-BR") @db.VarChar(10)
  voiceId           String?             @db.VarChar(100)
  enableMotion      Boolean             @default(false)
  mustInclude       String?
  mustExclude       String?
  scriptStyleId     String?
  visualStyleId     String?
  seedId            String?
  status            OutputStatus        @default(PENDING)
  scriptApproved    Boolean             @default(false)
  imagesApproved    Boolean             @default(false)
  videosApproved    Boolean             @default(false)
  outputData        Bytes?
  outputMimeType    String?             @db.VarChar(50)
  outputSize        Int?
  thumbnailPath     String?             @db.VarChar(500)
  errorMessage      String?
  pipelineLog       Json?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  completedAt       DateTime?
  dossierId         String
  audioTracks       AudioTrack[]
  relationsFrom     OutputRelation[]    @relation("MainOutput")
  relationsTo       OutputRelation[]    @relation("RelatedOutput")
  dossier           Dossier             @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  scriptStyle       ScriptStyle?        @relation(fields: [scriptStyleId], references: [id])
  seed              Seed?               @relation("OutputSeed", fields: [seedId], references: [id])
  visualStyle       VisualStyle?        @relation(fields: [visualStyleId], references: [id])
  executions        PipelineExecution[]
  scenes            Scene[]
  script            Script?

  @@index([dossierId])
  @@index([outputType])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@map("outputs")
}

/// Relação entre outputs (ex: teaser → full)
model OutputRelation {
  id              String   @id @default(uuid())
  mainOutputId    String
  relatedOutputId String
  relationType    String   @db.VarChar(50)
  createdAt       DateTime @default(now())
  mainOutput      Output   @relation("MainOutput", fields: [mainOutputId], references: [id], onDelete: Cascade)
  relatedOutput   Output   @relation("RelatedOutput", fields: [relatedOutputId], references: [id], onDelete: Cascade)

  @@unique([mainOutputId, relatedOutputId])
  @@index([relationType])
  @@map("output_relations")
}

/// Roteiro completo do output
model Script {
  id         String     @id @default(uuid())
  outputId   String     @unique
  summary    String
  fullText   String
  wordCount  Int        @default(0)
  provider   AIProvider
  modelUsed  String?    @db.VarChar(100)
  promptUsed String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  output     Output     @relation(fields: [outputId], references: [id], onDelete: Cascade)

  @@map("scripts")
}

/// Cena individual do output
model Scene {
  id                String       @id @default(uuid())
  outputId          String
  order             Int
  narration         String
  visualDescription String
  audioDescription  String?
  startTime         Float?
  endTime           Float?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  images            SceneImage[]
  videos            SceneVideo[]
  output            Output       @relation(fields: [outputId], references: [id], onDelete: Cascade)

  @@index([outputId])
  @@index([outputId, order])
  @@map("scenes")
}

/// Imagem gerada para uma cena
model SceneImage {
  id           String     @id @default(uuid())
  sceneId      String
  provider     AIProvider
  promptUsed   String
  fileData     Bytes?
  mimeType     String?    @db.VarChar(50)
  originalSize Int?
  width        Int?
  height       Int?
  isSelected   Boolean    @default(false)
  variantIndex Int        @default(0)
  createdAt    DateTime   @default(now())
  scene        Scene      @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@map("scene_images")
}

/// Vídeo/Motion gerado para uma cena
model SceneVideo {
  id            String     @id @default(uuid())
  sceneId       String
  provider      AIProvider
  promptUsed    String?
  fileData      Bytes?
  mimeType      String?    @db.VarChar(50)
  originalSize  Int?
  duration      Float?
  sourceImageId String?
  isSelected    Boolean    @default(false)
  variantIndex  Int        @default(0)
  createdAt     DateTime   @default(now())
  scene         Scene      @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@map("scene_videos")
}

/// Trilha de áudio gerada
model AudioTrack {
  id           String     @id @default(uuid())
  outputId     String
  type         String     @db.VarChar(50)
  provider     AIProvider
  voiceId      String?    @db.VarChar(100)
  fileData     Bytes?
  mimeType     String?    @db.VarChar(50)
  originalSize Int?
  duration     Float?
  createdAt    DateTime   @default(now())
  output       Output     @relation(fields: [outputId], references: [id], onDelete: Cascade)

  @@index([outputId])
  @@map("audio_tracks")
}

/// Configuração de provedores de IA
model ProviderConfig {
  id                String     @id @default(uuid())
  provider          AIProvider @unique
  apiKey            String     @db.VarChar(500)
  isActive          Boolean    @default(true)
  settings          Json?
  requestsPerMinute Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@map("provider_configs")
}

/// Logs de execução do pipeline
model PipelineExecution {
  id         String   @id @default(uuid())
  outputId   String
  step       String   @db.VarChar(50)
  status     String   @db.VarChar(20)
  message    String?
  metadata   Json?
  durationMs Int?
  createdAt  DateTime @default(now())
  output     Output   @relation(fields: [outputId], references: [id], onDelete: Cascade)

  @@index([outputId])
  @@index([createdAt])
  @@map("pipeline_executions")
}

/// Estilos visuais disponíveis para geração de imagens e vídeos
model VisualStyle {
  id              String   @id @default(uuid())
  name            String   @db.VarChar(100)
  description     String
  baseStyle       String
  lightingTags    String
  atmosphereTags  String
  compositionTags String
  tags            String
  order           Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  outputs         Output[]
  seeds           Seed[]

  @@index([isActive, order])
  @@map("visual_styles")
}

/// Estilos de roteiro disponíveis para geração de scripts
model ScriptStyle {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  description  String
  instructions String
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  outputs      Output[]

  @@index([isActive, order])
  @@map("script_styles")
}

/// Seeds para geração de imagens/vídeos (receitas visuais)
model Seed {
  id            String      @id @default(uuid())
  name          String      @db.VarChar(100)
  description   String?
  value         Int
  visualStyleId String
  category      String?     @db.VarChar(50)
  tags          String?
  usageCount    Int         @default(0)
  isDefault     Boolean     @default(false)
  isActive      Boolean     @default(true)
  previewUrl    String?     @db.VarChar(500)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  outputs       Output[]    @relation("OutputSeed")
  visualStyle   VisualStyle @relation(fields: [visualStyleId], references: [id], onDelete: Cascade)

  @@unique([visualStyleId, value])
  @@index([visualStyleId, isActive])
  @@index([isDefault])
  @@map("seeds")
}

/// Tipo de provedor de IA usado
enum AIProvider {
  OPENAI
  ANTHROPIC
  GEMINI
  ELEVENLABS
  MIDJOURNEY
  STABLE_DIFFUSION
  RUNWAY
  REPLICATE
}

/// Tipo de output gerado a partir de um documento
enum OutputType {
  VIDEO_TEASER
  VIDEO_FULL
  TWITTER_THREAD
  LINKEDIN_POST
  INSTAGRAM_POST
  PODCAST_EPISODE
  BLOG_ARTICLE
}

/// Status de geração do output
enum OutputStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
}
